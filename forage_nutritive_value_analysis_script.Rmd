---
title: "forage_nutritive_value_analysis_script"
author: "Hannah Phillips"
date: "March 23, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F, message = F, warning = F}
library(readxl) #read data
library(tidyverse) #piping
library(lme4) #lmer
library(lmerTest) # KR ddf
library(MuMIn) #r.squaredGLMM
library(ggplot2) #plots
library(merTools)
library(afex) #CIs
library(dplyr)

#count if not NA function
countFun = function(x){sum(!is.na(x))}

#clean up residual and supply data
Supply.dat = read_excel("C:/Users/Hannah/Desktop/Forage paper/Nutritive value/original_yield_data.xlsx", sheet = "Supply") %>%
  mutate(Supply = (Bag_sample_dry - Bag) * 0.000001 / 0.000023) %>% #convert g to Mg per ha
  mutate(Supply.DM = (Bag_sample_dry - Bag) / (Bag_sample_wet - Bag)) %>%
  mutate_at(vars(Forage, Rep, Pen), as.factor) %>%
  dplyr::select(c(Rep, Day, Pen, Forage, Supply, Supply.DM)) %>%
  mutate(Supply = ifelse(Supply < 0 | Supply.DM > 1 | Supply.DM < 0, NA, Supply)) %>%
  mutate(Supply = ifelse(Day == 46 & Pen == 3, NA, Supply)) %>% #remove pen, I think it was mixed up with another sample
  dplyr::select(c(Day, Pen, Forage, Supply)) %>%
  group_by(Day, Pen, Forage) %>%
  summarise_all(funs(mean(., na.rm = T)))

Residual.dat = read_excel("C:/Users/Hannah/Desktop/Forage paper/Nutritive value/original_yield_data.xlsx", sheet = "Residual") %>%
  mutate(Residual = (Bag_sample_dry - Bag) * 0.000001 / 0.000023) %>% #convert g to Mg per ha
  mutate(Residual.DM = (Bag_sample_dry - Bag) / (Bag_sample_wet - Bag)) %>%
  mutate_at(vars(Forage, Rep, Pen), as.factor) %>%
  dplyr::select(c(Rep, Day, Days, Pen, Forage, Residual, Residual.DM)) %>%
  mutate(Residual = ifelse(Residual.DM > 1 | Residual.DM < 0, NA, Residual)) %>%
  dplyr::select(c(Day, Pen, Forage, Residual, Days)) %>%
  group_by(Day, Pen, Forage) %>%
  summarise_all(funs(mean(., na.rm = T)))
  
quality.dat = read_excel("C:/Users/Hannah/Desktop/Forage paper/Nutritive value/nutritive_value_data.xlsx") %>% 
              mutate(Day = Day - 1) %>% 
              dplyr::select(c(Day, Pen, Paddock, Forage, CP, Fat, ADF, NDF, NFC, Phosphorus:Iron, TTNDFD))

#merges yield and nutritive value data
dat = merge(quality.dat, merge(Supply.dat, Residual.dat, by = c("Day", "Pen", "Forage")), by = c("Day", "Pen", "Forage"), all.x  = T) %>%    
    mutate_at(vars(Forage, Paddock, Pen), as.factor)

  #mutate(Head = ifelse(Pen == "3", 4, 5)) %>%
  #mutate(Removal.biomass = ((Supply - Residual) * 1000 / Head / Days)) %>% #convert Mg to kg
  #mutate(Removal.percent = ((Supply - Residual)/Supply/ Head / Days)) %>%
  #mutate(Removal.biomass = ifelse(Removal.percent < 0 | Removal.percent > .05 | Removal.biomass > 30 | Removal.biomass < -10, NA, Removal.biomass)) %>% #removed data that had greater than 75% total forage removal and less than 0% forage removal
  #mutate(Removal.percent = ifelse(Removal.percent < 0 | Removal.percent > .05 | Removal.biomass > 30 | Removal.biomass > 100, NA, Removal.percent)) %>% 
  #mutate(BW = ifelse(Pen == "1", .435, ifelse(Pen == "2", .459, ifelse(Pen == "3", .408, ifelse(Pen == "4", .445, ifelse(Pen == "5", .417, .366))))))
  
dat[,10:16] = dat[,10:16]*10 #convert minerals to g per kg


```

# Create dataset to use for predictions & function
```{r, include = F}
#create data to make predictions from
newDat = data.frame(Day = rep(0:46, 2), 
                    Forage = c(rep("Rye", 47), 
                               rep("Wheat", 47)), 
                    Pen = NA, 
                    Paddock = NA)

#create prediction function
predict.fun <- function(my.lmm) {
  predict(my.lmm, newdata = newDat, re.form = NA) 
}

#for DMI
newDat.DMI = data.frame(Day = rep(0:46, 2), 
                    Forage = c(rep("Rye", 47), 
                               rep("Wheat", 47)), 
                    Pen = NA, 
                    Paddock = NA,
                    BW = 0.42,
                    Yield = 3.5)


#create prediction function
predict.fun.DMI <- function(my.lmm) {
  predict(my.lmm, newdata = newDat.DMI, re.form = NA) 
}
```

# yield
```{r, message = F}
ggplot(data = dat, 
       aes(x = Day, y = Supply, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(Supply ~ poly(Day, 3)*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, 
                          Forage <- relevel(Forage, ref = "Rye")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 3)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)

```

# yield plot
```{r, echo = F}
# Predicted fitted values
newDat.yield = newDat
newDat.yield$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.yield <- cbind(newDat.yield, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

boot.ci.yield <- data.frame(bootMer(model, predict.fun, nsim = 1000, seed = 1)) 

min(subset(newDat.yield, Forage == "Rye")$fit)
max(subset(newDat.yield, Forage == "Rye")$fit)
min(subset(newDat.yield, Forage == "Wheat")$fit)
max(subset(newDat.yield, Forage == "Wheat")$fit)


#Difference between rye - wheat on d0
mean(data.frame(boot.ci.yield$X1 - boot.ci.yield$X48)[,1])
quantile(data.frame(boot.ci.yield$X1 - boot.ci.yield$X48)[,1], 0.025)
quantile(data.frame(boot.ci.yield$X1 - boot.ci.yield$X48)[,1], 0.975)

#Difference between rye - wheat on d2
mean(data.frame(boot.ci.yield$X3 - boot.ci.yield$X50)[,1])
quantile(data.frame(boot.ci.yield$X3 - boot.ci.yield$X50)[,1], 0.025)
quantile(data.frame(boot.ci.yield$X3 - boot.ci.yield$X50)[,1], 0.975)

#Difference between rye - wheat on d22
mean(data.frame(boot.ci.yield$X23 - boot.ci.yield$X70)[,1])
quantile(data.frame(boot.ci.yield$X23 - boot.ci.yield$X70)[,1], 0.025)
quantile(data.frame(boot.ci.yield$X23 - boot.ci.yield$X70)[,1], 0.975)

#Difference between wheat - rye on d33
mean(data.frame(boot.ci.yield$X81 - boot.ci.yield$X34)[,1])
quantile(data.frame(boot.ci.yield$X81 - boot.ci.yield$X34)[,1], 0.025)
quantile(data.frame(boot.ci.yield$X81 - boot.ci.yield$X34)[,1], 0.975)

#Difference between wheat - rye on d43
mean(data.frame(boot.ci.yield$X91 - boot.ci.yield$X44)[,1])
quantile(data.frame(boot.ci.yield$X91 - boot.ci.yield$X44)[,1], 0.025)
quantile(data.frame(boot.ci.yield$X91 - boot.ci.yield$X44)[,1], 0.975)

{
  ggplot(data = dat, 
         aes(x = Day, y = Supply, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.yield, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.yield, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.yield, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "Biomass yield, Mg ha\u207B\u00B9") +  
  
  scale_y_continuous(breaks = seq(0, 6, 1), 
                     limits = c(0, 6), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.1, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# CP
```{r, message = F}
hist(dat$CP)
ggplot(data = dat, 
       aes(x = Day, y = CP, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(CP ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 2)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# CP plot
```{r, echo = F}
# Predicted fitted values
newDat.CP = newDat
newDat.CP$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.CP <- cbind(newDat.CP, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

{
  ggplot(data = dat, 
         aes(x = Day, y = CP, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.CP, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.CP, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.CP, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "Crude protein, g 100g\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(10, 30, 5), 
                     limits = c(9, 30), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Fat
```{r, message = F}
hist(dat$Fat)
ggplot(data = dat, 
       aes(x = Day, y = Fat, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(Fat ~ poly(Day,2)*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))


#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 2)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# fat plot
```{r, echo = F}
# Predicted fitted values
newDat.fat = newDat
newDat.fat$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.fat <- cbind(newDat.fat, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

{
  ggplot(data = dat, 
         aes(x = Day, y = Fat, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.fat, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.fat, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.fat, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "Fat, g 100g\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(2, 3.5, .25), 
                     limits = c(2, 3.5), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# NFC
```{r, message = F}
hist(dat$NFC)
ggplot(data = dat, 
       aes(x = Day, y = NFC, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(NFC ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Rye")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 2)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# NFC plot
```{r, echo = F}
# Predicted fitted values
newDat.nfc = newDat
newDat.nfc$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.nfc <- cbind(newDat.nfc, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

min(subset(newDat.nfc, Forage == "Rye")$fit)
max(subset(newDat.nfc, Forage == "Rye")$fit)
min(subset(newDat.nfc, Forage == "Wheat")$fit)
max(subset(newDat.nfc, Forage == "Wheat")$fit)

{
  ggplot(data = dat, 
         aes(x = Day, y = NFC, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.nfc, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.nfc, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.nfc, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "Non-fiber carbohydrates, g 100g\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(15, 40, 5), 
                     limits = c(15, 40), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# NDF
```{r, message = F}
hist(dat$NDF)
ggplot(data = dat, 
       aes(x = Day, y = NDF, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(NDF ~ poly(Day, 2)*Forage + (1|Pen) + (1|Paddock/Forage), control = lmerControl(optimizer = "Nelder_Mead"), data = within(dat, Forage <- relevel(Forage, ref = "Rye")))


#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 2)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# NDF plot
```{r, echo = F}
# Predicted fitted values
newDat.ndf = newDat
newDat.ndf$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.ndf <- cbind(newDat.ndf, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

boot.ci.ndf <- data.frame(bootMer(model, predict.fun, nsim = 1000, seed = 1)) 

min(subset(newDat.ndf, Forage == "Rye")$fit)
max(subset(newDat.ndf, Forage == "Rye")$fit)
min(subset(newDat.ndf, Forage == "Wheat")$fit)
max(subset(newDat.ndf, Forage == "Wheat")$fit)


#Difference between rye - wheat on d0
mean(data.frame(boot.ci.ndf$X1 - boot.ci.ndf$X48)[,1])
quantile(data.frame(boot.ci.ndf$X1 - boot.ci.ndf$X48)[,1], 0.025)
quantile(data.frame(boot.ci.ndf$X1 - boot.ci.ndf$X48)[,1], 0.975)

#Difference between rye - wheat on d5
mean(data.frame(boot.ci.ndf$X6 - boot.ci.ndf$X53)[,1])
quantile(data.frame(boot.ci.ndf$X6 - boot.ci.ndf$X53)[,1], 0.025)
quantile(data.frame(boot.ci.ndf$X6 - boot.ci.ndf$X53)[,1], 0.975)

#Difference between rye - wheat on d36
mean(data.frame(boot.ci.ndf$X37 - boot.ci.ndf$X84)[,1])
quantile(data.frame(boot.ci.ndf$X37 - boot.ci.ndf$X84)[,1], 0.025)
quantile(data.frame(boot.ci.ndf$X37 - boot.ci.ndf$X84)[,1], 0.975)



{
  ggplot(data = dat, 
         aes(x = Day, y = NDF, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.ndf, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.ndf, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.ndf, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "NDF, g 100g\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(30, 60, 5), 
                     limits = c(30, 60), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.1, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# ADF
```{r, message = F}
hist(dat$ADF)
ggplot(data = dat, 
       aes(x = Day, y = ADF, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(ADF ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))

#left off

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 2)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# ADF plot
```{r, echo = F}
# Predicted fitted values
newDat.adf = newDat
newDat.adf$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.adf <- cbind(newDat.adf, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

{
  ggplot(data = dat, 
         aes(x = Day, y = ADF, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.adf, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.adf, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.adf, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "ADF, g 100g\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(20, 40, 5), 
                     limits = c(20, 40), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.1, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# TTNDFD
```{r, message = F}
hist(dat$TTNDFD)
ggplot(data = dat, 
       aes(x = Day, y = TTNDFD, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(TTNDFD ~ poly(Day,2)*Forage + (1|Pen) + (1|Paddock/Forage), control = lmerControl(optimizer = "Nelder_Mead"), data = within(dat, Forage <- relevel(Forage, ref = "Rye")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 2)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# TTNDFD plot
```{r, echo = F}
# Predicted fitted values
newDat.ttndfd = newDat
newDat.ttndfd$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.ttndfd <- cbind(newDat.ttndfd, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

min(subset(newDat.ttndfd, Forage == "Rye")$fit)
max(subset(newDat.ttndfd, Forage == "Rye")$fit)
min(subset(newDat.ttndfd, Forage == "Wheat")$fit)
max(subset(newDat.ttndfd, Forage == "Wheat")$fit)

boot.ci.ttndfd <- data.frame(bootMer(model, predict.fun, nsim = 1000, seed = 1)) 

mean(subset(newDat.ttndfd, Day == "46")$fit)

#Difference between rye - wheat on d0
mean(data.frame(boot.ci.ndf$X1 - boot.ci.ndf$X48)[,1])
quantile(data.frame(boot.ci.ndf$X1 - boot.ci.ndf$X48)[,1], 0.025)
quantile(data.frame(boot.ci.ndf$X1 - boot.ci.ndf$X48)[,1], 0.975)

#Difference between rye - wheat on d5
mean(data.frame(boot.ci.ndf$X6 - boot.ci.ndf$X53)[,1])
quantile(data.frame(boot.ci.ndf$X6 - boot.ci.ndf$X53)[,1], 0.025)
quantile(data.frame(boot.ci.ndf$X6 - boot.ci.ndf$X53)[,1], 0.975)

#Difference between rye - wheat on d36
mean(data.frame(boot.ci.ndf$X37 - boot.ci.ndf$X84)[,1])
quantile(data.frame(boot.ci.ndf$X37 - boot.ci.ndf$X84)[,1], 0.025)
quantile(data.frame(boot.ci.ndf$X37 - boot.ci.ndf$X84)[,1], 0.975)


{
  ggplot(data = dat, 
         aes(x = Day, y = TTNDFD, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.ttndfd, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.ttndfd, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.ttndfd, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "TTNDFD, g 100g\u207B\u00B9 of NDF") +  
  
  scale_y_continuous(breaks = seq(30, 75, 5), 
                     limits = c(30, 75), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Potassium
```{r, message = F}
mean(dat$Potassium)

hist(dat$Potassium)
ggplot(data = dat, 
       aes(x = Day, y = Potassium, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(Potassium ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Rye")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 2)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Potassium plot
```{r, echo = F}
# Predicted fitted values
newDat.K = newDat
newDat.K$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.K <- cbind(newDat.K, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

{
  ggplot(data = dat, 
         aes(x = Day, y = Potassium, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.K, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.K, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.K, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "Potassium, g kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(10, 50, 5), 
                     limits = c(10, 50), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Chloride
```{r, message = F}
hist(dat$Chloride)
ggplot(data = dat, 
       aes(x = Day, y = Chloride, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(Chloride ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 2)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Calcium
```{r, message = F}
hist(dat$Calcium)
ggplot(data = dat, 
       aes(x = Day, y = Calcium, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(Calcium ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))


#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 3)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Calcium plot
```{r, echo = F}
# Predicted fitted values
newDat.Ca = newDat
newDat.Ca$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.Ca <- cbind(newDat.Ca, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

{
  ggplot(data = dat, 
         aes(x = Day, y = Calcium, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.Ca, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.Ca, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.Ca, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "Calcium, g kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(0, 7, 1), 
                     limits = c(0, 7), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Phosphorus
```{r, message = F}
hist(dat$Phosphorus)
ggplot(data = dat, 
       aes(x = Day, y = Phosphorus, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(Phosphorus ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))


#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 3)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Phosphorus plot
```{r, echo = F}
# Predicted fitted values
newDat.P = newDat
newDat.P$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.P <- cbind(newDat.P, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

{
  ggplot(data = dat, 
         aes(x = Day, y = Phosphorus, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.P, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.P, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.P, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "Phosphorus, g kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(0, 7, 1), 
                     limits = c(0, 7), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Sulfur
```{r, message = F}
hist(dat$Sulfur)
ggplot(data = dat, 
       aes(x = Day, y = Sulfur, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(Sulfur ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Rye")))


#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 4)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Sulfur plot
```{r, echo = F}
# Predicted fitted values
newDat.S = newDat
newDat.S$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.S <- cbind(newDat.S, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

{
  ggplot(data = dat, 
         aes(x = Day, y = Sulfur, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.S, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.S, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.S, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "Sulfur, g kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(0, 3, 0.5), 
                     limits = c(0, 3), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Magnessium
```{r, message = F}
hist(dat$Magnessium)
ggplot(data = dat, 
       aes(x = Day, y = Magnessium, color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(Magnessium ~ poly(Day, 2)*Forage + (1|Pen) + (1|Paddock/Forage), control = lmerControl(optimizer = "Nelder_Mead"), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 3)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Magnessium plot
```{r, echo = F}
# Predicted fitted values
newDat.Mg = newDat
newDat.Mg$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.Mg <- cbind(newDat.Mg, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))

{
  ggplot(data = dat, 
         aes(x = Day, y = Magnessium, color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.Mg, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.Mg, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.Mg, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "Magnesium, g kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(0, 2.5, 0.5), 
                     limits = c(0, 2.5), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Iron
```{r, message = F}
hist(log(dat$Iron))

ggplot(data = dat, 
       aes(x = Day, y = log(Iron), color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(log(Iron) ~ poly(Day, 2)*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))


#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 3)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Iron plot
```{r, echo = F}
# Predicted fitted values
newDat.Fe = newDat
newDat.Fe$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.Fe <- cbind(newDat.Fe, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))


{
  ggplot(data = dat, 
         aes(x = Day, y = log(Iron), color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.Fe, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.Fe, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.Fe, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "log(Iron), mg kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(0, 9, 1), 
                     limits = c(0, 9), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Aluminum
```{r, message = F}
hist(log(dat$Aluminum))

ggplot(data = dat, 
       aes(x = Day, y = log(Aluminum), color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(log(Aluminum) ~ poly(Day, 2)*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 3)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Aluminum plot
```{r, echo = F}
# Predicted fitted values
newDat.Al = newDat
newDat.Al$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.Al <- cbind(newDat.Al, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))


{
  ggplot(data = dat, 
         aes(x = Day, y = log(Aluminum), color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.Al, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.Al, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.Al, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "log(Aluminum), mg kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(3.5, 8, .5), 
                     limits = c(3.5, 8), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Manganese
```{r, message = F}
hist(log(dat$Manganese))
ggplot(data = dat, 
       aes(x = Day, y = log(Manganese), color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(log(Manganese) ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 3)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Manganese plot
```{r, echo = F}
# Predicted fitted values
newDat.Mn = newDat
newDat.Mn$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.Mn <- cbind(newDat.Mn, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))


{
  ggplot(data = dat, 
         aes(x = Day, y = log(Manganese), color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.Mn, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.Mn, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.Mn, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "log(Manganese), mg kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(2.5, 5.5, .5), 
                     limits = c(2.5, 5.5), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Zinc
```{r, message = F}
hist(log(dat$Zinc))
hist(dat$Zinc)

ggplot(data = dat, 
       aes(x = Day, y = log(Zinc), color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(log(Zinc) ~ poly(Day, 2)*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))


#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 3)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Zinc plot
```{r, echo = F}
# Predicted fitted values
newDat.Zn = newDat
newDat.Zn$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.Zn <- cbind(newDat.Zn, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))


{
  ggplot(data = dat, 
         aes(x = Day, y = log(Zinc), color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.Zn, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.Zn, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.Zn, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "log(Zinc), mg kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(2.25, 3.5, .25), 
                     limits = c(2.25, 3.5), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```

# Copper
```{r, message = F}
hist(log(dat$Copper))
hist(dat$Copper)

ggplot(data = dat, 
       aes(x = Day, y = log(Copper), color = Forage)) + 
  geom_point(size = 2, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01))

#model
model = lmer(log(Copper) ~ Day*Forage + (1|Pen) + (1|Paddock/Forage), data = within(dat, Forage <- relevel(Forage, ref = "Wheat")))

#diagnostics
plot(model, main = "Residuals vs fitted")
qqnorm(resid(model))
qqline(resid(model))

#regression coefficients 
summary(model, ddf = "Kenward-Roger")
round(confint(model), 5)
anova(model, ddf = "Kenward-Roger")

#random effects
as.data.frame(VarCorr(model))

#R squared
r.squaredGLMM(model)
```

# Copper plot
```{r, echo = F}
# Predicted fitted values
newDat.Cu = newDat
newDat.Cu$fit <- predict.fun(model)

# 95% confidence intervals based on 1000 bootstrap resamples 
newDat.Cu <- cbind(newDat.Cu, confint(bootMer(model, predict.fun, nsim = 1000, seed = 1), type = "perc"))


{
  ggplot(data = dat, 
         aes(x = Day, y = log(Copper), color = Forage)) + 
  
  geom_point(size = 1.5, 
             show.legend = T,
             position = position_jitter(h = 0.01, w = 0.01),
             alpha = 0.5) +
  
  scale_color_manual(breaks = c("Rye", "Wheat"), 
                     values = c("darkred", "dodgerblue4")) + 
  
  geom_line(data = newDat.Cu, 
            aes(x = Day, y = fit, group = Forage), 
            size = 1) +
  
  geom_ribbon(data = subset(newDat.Cu, Forage == "Rye"), 
              aes(x = Day, ymin =`2.5 %`, ymax = `97.5 %`),
              fill = "darksalmon", 
              alpha = 0.5, 
              inherit.aes = FALSE) +
  
  geom_ribbon(data = subset(newDat.Cu, Forage == "Wheat"), 
              aes(x = Day, ymin = `2.5 %`, ymax = `97.5 %`),
              fill = "lightskyblue1", alpha = 0.5, inherit.aes = FALSE) +
  
  theme_classic() +
    
  labs(x = "Day of grazing period", 
       y = "log(Copper), mg kg\u207B\u00B9 of dry matter forage") +  
  
  scale_y_continuous(breaks = seq(1, 2.25, .25), 
                     limits = c(1, 2.25), expand = c(0,0)) +
  
  scale_x_continuous(breaks = seq(0, 46, 2), limits = c(-1, 47), expand = c(0,0)) +
  
  theme(axis.title = element_text(size = 14),
        plot.caption = element_text(size = 11, hjust = 0),   
        axis.text = element_text(size = 11, colour = "black"),
        legend.position = c(.9, .9),
        legend.title = element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 11),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)))
  }
```
